<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cardápio – QR Pastéis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --green:#09a66b; --dark:#0f172a; --muted:#6b7280; --line:#e5e7eb }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;font-family:'Poppins',system-ui;background:#fff;color:#111}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    .brand h1{font-size:24px;margin:0}
    .brand small{color:var(--muted)}
    .searchbar{display:flex;gap:12px;flex-wrap:wrap}
    input, select, textarea{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:inherit}
    input:focus, select:focus, textarea:focus{outline:2px solid #9ae7c9}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .chip{border:1px solid var(--line);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
    .chip.active{background:var(--green);color:#fff;border-color:var(--green)}
    main{display:grid;grid-template-columns:1fr 320px;gap:24px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0 0 4px 0;font-size:18px}
    .badge{background:#fff3c4;border:1px solid #facc15;color:#92400e;font-size:12px;padding:2px 6px;border-radius:8px;margin-left:6px}
    .price{font-weight:700}
    .actions{display:flex;gap:8px;margin-top:auto}
    .btn{border:none;background:var(--green);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#eefbf5;color:#0b5c3f;border:1px solid #b7f0d9}
    aside{border:1px solid var(--line);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px;position:sticky;top:16px;height:max-content}
    .row{display:flex;gap:8px}
    .row>div{flex:1}
    .totals{display:flex;align-items:center;justify-content:space-between;padding-top:8px;border-top:1px dashed var(--line)}
    footer{margin-top:24px;color:var(--muted);font-size:14px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1 id="shopName">Loja</h1>
      <small id="address">Endereço</small>
    </div>
    <div class="searchbar">
      <input id="searchInput" type="search" placeholder="Buscar item (ex.: queijo, refri)"/>
    </div>
  </header>

  <div class="chips">
    <span class="chip active" data-filter="todos">Todos</span>
    <span class="chip" data-filter="pastel">Pastéis</span>
    <span class="chip" data-filter="bebida">Bebidas</span>
    <span class="chip" data-filter="cerveja">Cervejas</span>
    <span class="chip" data-filter="espetinho">Espetinhos</span>
    <span class="chip" data-filter="promo">Promoções</span>
  </div>

  <main>
    <section>
      <div id="menuGrid" class="grid"></div>
    </section>

    <aside>
      <h2 id="shopName2">Loja</h2>

      <!-- Dados do cliente -->
      <div class="row">
        <div>
          <label for="customerName">Nome *</label>
          <input id="customerName" type="text" placeholder="Ex.: João Silva" required/>
        </div>
      </div>
      <div>
        <label for="customerAddress">Endereço / Observações</label>
        <textarea id="customerAddress" rows="2" placeholder="Ex.: Entregar na Rua X, nº Y, apt Z"></textarea>
      </div>

      <!-- Pagamento -->
      <div>
        <label for="payment">Forma de Pagamento</label>
        <select id="payment">
          <option value="Dinheiro">Dinheiro</option>
          <option value="Cartão de Débito">Cartão de Débito</option>
          <option value="Cartão de Crédito">Cartão de Crédito</option>
          <option value="Pix">Pix</option>
        </select>
      </div>

      <!-- Carrinho -->
      <div class="totals">
        <strong>Itens: <span id="cartCount">0</span></strong>
        <strong>Total: <span id="cartTotal">R$ 0,00</span></strong>
      </div>

      <div class="row">
        <button id="clearBtn" class="btn ghost" type="button">Limpar</button>
        <button id="checkoutBtn" class="btn" type="button">Enviar WhatsApp</button>
      </div>

      <small style="color:var(--muted)">Campo nome é obrigatório para enviar.</small>
    </aside>
  </main>

  <footer>
    © <span id="year"></span> • <span id="shopNameFoot">HelpTech</span>
  </footer>

  <!-- Config com seu número e dados da loja -->
  <script type="module" src="./config.js"></script>
  <!-- App -->
  <script type="module" src="./app.js"></script>

  <!-- ADIÇÃO: anexa Nome/Endereço/Pagamento ao WhatsApp (não altera sua estrutura) -->
  <script type="module">
    import { CONFIG } from "./config.js";

    (function () {
      const btn = document.getElementById('checkoutBtn');
      if (!btn) return;

      function getText(el) { return (el?.textContent || '').trim(); }

      function tryParseJSON(str) {
        try { return JSON.parse(str); } catch { return null; }
      }

      function getCartFromKnownPlaces() {
        // 1) Objetos globais comuns
        const globals = [window.__CART__, window.CART, window.cart];
        for (const g of globals) {
          if (!g) continue;
          const arr = Array.isArray(g) ? g : (Array.isArray(g.items) ? g.items : null);
          if (arr) return arr;
        }

        // 2) LocalStorage – chaves prováveis
        const keys = ['ht_cart', 'cart', 'menu_cart', 'helptech_cart', 'app_cart'];
        for (const k of keys) {
          const raw = localStorage.getItem(k);
          if (!raw) continue;
          const parsed = tryParseJSON(raw);
          if (!parsed) continue;

          if (Array.isArray(parsed)) return parsed;
          if (Array.isArray(parsed?.items)) return parsed.items;
          if (Array.isArray(parsed?.data)) return parsed.data;
        }

        return null;
      }

      function formatBRL(numLike) {
        const n = typeof numLike === 'number'
          ? numLike
          : Number(String(numLike).replace(/[^\d,.-]/g, '').replace('.', '').replace(',', '.'));
        if (Number.isFinite(n)) {
          return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n);
        }
        return String(numLike);
      }

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopImmediatePropagation();

        const name = document.getElementById('customerName')?.value?.trim() || '';
        if (!name) {
          alert('Informe seu nome para continuar.');
          return;
        }
        const address = document.getElementById('customerAddress')?.value?.trim() || '';
        const payment = document.getElementById('payment')?.value || 'Dinheiro';

        const shop = getText(document.getElementById('shopName2')) || getText(document.getElementById('shopName')) || 'Pedido';
        const count = getText(document.getElementById('cartCount')) || '';
        const total = getText(document.getElementById('cartTotal')) || '';

        // Tenta recuperar itens detalhados do carrinho
        const items = getCartFromKnownPlaces();

        let lines = [];
        lines.push(`*${shop}*`);
        lines.push(``);
        lines.push(`— *Meu pedido* —`);

        if (items && items.length) {
          // Formatos esperados: { name/nome/title/titulo/descricao/desc, qty/qtd/quantidade, price/preco, total/subtotal }
          items.forEach((it, idx) => {
            const nameKey = it.name || it.nome || it.title || it.titulo || it.descricao || it.desc || `Item ${idx+1}`;
            const qtyKey  = it.qty ?? it.quantidade ?? it.qtd ?? 1;
            const subKey  = it.total ?? it.subtotal ?? (typeof it.price !== 'undefined' ? (it.price * (qtyKey || 1)) : undefined);
            const priceStr = typeof subKey !== 'undefined' ? ` – ${formatBRL(subKey)}` : '';
            lines.push(`• ${nameKey} x${qtyKey}${priceStr}`);
          });
        } else {
          if (count) lines.push(`Itens: ${count}`);
        }

        if (total) lines.push(`*Total:* ${total}`);

        lines.push(``);
        lines.push(`— *Dados do cliente* —`);
        lines.push(`Nome: ${name}`);
        if (address) lines.push(`Endereço/Obs.: ${address}`);
        lines.push(`Pagamento: ${payment}`);

        const text = lines.join('\n');

        // Abre WhatsApp
        const phone = (CONFIG?.phone || '').replace(/[^\d]/g, '');
        const base = phone ? `https://wa.me/${phone}` : `https://wa.me/`;
        const url = `${base}?text=${encodeURIComponent(text)}`;

        window.location.href = url;
      }, { capture: true });
    })();
  </script>
  <!-- FIM ADIÇÃO -->
</body>
</html>
